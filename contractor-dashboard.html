<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contractor Dashboard — Service Point SA</title>
  <style>
    :root{--bg:#061018;--card:#07121a;--accent:#00c6ff;--muted:#9aa3ad}
    body{margin:0;background:linear-gradient(180deg,#041018,#06121a);color:#e7f0f5;font-family:Inter,system-ui,Arial}
    .container{padding:18px;display:grid;grid-template-columns:280px 1fr;gap:18px;height:100vh;box-sizing:border-box}
    .sidebar{background:var(--card);border-radius:10px;padding:16px}
    .content{background:var(--card);border-radius:10px;padding:16px;overflow:auto}
    .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;margin-bottom:12px}
    h1{margin:0 0 12px 0}
    .muted{color:var(--muted);font-size:13px}
    .btn{background:linear-gradient(90deg,#6a5cff,#00c6ff);padding:8px 10px;border-radius:8px;color:white;border:none;cursor:pointer}
    .stat{display:flex;gap:12px;align-items:center}
    .messages{max-height:360px;overflow:auto}
    .msg{padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02)}
    .customize{display:flex;gap:8px;align-items:center}
    input,select,textarea{background:#051017;border:1px solid rgba(255,255,255,0.03);color:#e7f0f5;padding:8px;border-radius:8px;width:100%;box-sizing:border-box}
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h3>Contractor Dashboard</h3>
      <div id="contractor-welcome" style="margin-bottom:12px">Please log in</div>

      <div id="login-card" class="card">
        <label>Phone</label><input id="login-phone" placeholder="0674099143">
        <label>Password</label><input id="login-pass" type="password">
        <div style="margin-top:8px"><button id="login-btn" class="btn" style="width:100%">Log in</button></div>
        <div id="login-msg" class="muted" style="margin-top:8px"></div>
      </div>

      <div id="profile-card" class="card" style="display:none">
        <div><strong id="profile-name"></strong></div>
        <div class="muted" id="profile-phone"></div>
        <div style="margin-top:8px"><button id="logout-btn" class="small">Logout</button></div>
      </div>

      <div class="card">
        <div class="muted">Customise</div>
        <div style="margin-top:8px" class="customize">
          <label style="min-width:56px">Theme</label>
          <select id="ui-theme"><option value="dark">Dark</option><option value="light">Light</option></select>
        </div>
        <div style="margin-top:8px">
          <label>Show premium blocks</label>
          <select id="premium-toggle"><option value="1">Yes</option><option value="0">No</option></select>
        </div>
      </div>

      <div class="card">
        <div class="muted">Help</div>
        <div style="margin-top:8px">Email: <a href="mailto:renurture.solutions@gmail.com" style="color:#b8f2ea">renurture.solutions@gmail.com</a></div>
      </div>
    </aside>

    <main class="content">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <h1 id="dash-title">Overview</h1>
          <div class="muted" id="dash-sub">Summary & messages</div>
        </div>
        <div>
          <button id="refresh-btn" class="btn">Refresh</button>
        </div>
      </header>

      <section id="overview" style="display:none">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px">
          <div class="card"><div class="muted">Total Leads</div><div id="ct-leads" style="font-size:22px;font-weight:700">—</div></div>
          <div class="card"><div class="muted">Accepted</div><div id="ct-accepted" style="font-size:22px;font-weight:700">—</div></div>
          <div class="card"><div class="muted">Response Rate</div><div id="ct-response" style="font-size:22px;font-weight:700">—</div></div>
        </div>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <div class="card">
              <strong>Messages</strong>
              <div id="messages" class="messages" style="margin-top:8px"></div>
              <div style="margin-top:8px">
                <textarea id="out-msg" rows="3" placeholder="Write message to admin or customers..."></textarea>
                <div style="margin-top:8px;display:flex;gap:8px">
                  <button id="send-out" class="btn">Send</button>
                </div>
              </div>
            </div>
          </div>

          <div style="width:320px">
            <div class="card">
              <strong>Quick Stats</strong>
              <div style="margin-top:8px" class="muted">Recent leads</div>
              <div id="recent-leads"></div>
            </div>

            <div class="card" style="margin-top:12px" id="premium-block" >
              <strong>Premium Panel</strong>
              <div class="muted" style="margin-top:8px">Upsell & analytics</div>
              <div id="premium-content" style="margin-top:8px">Upgrade to enable advanced features</div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

<script>
/*
  contractor-dashboard.js (embedded)
  - uses API endpoints exposed by your server
*/
const API_BASE = window.location.origin;
let CURRENT_CONTRACTOR = null;

document.getElementById('login-btn').addEventListener('click', async ()=>{
  const phone = document.getElementById('login-phone').value.trim();
  const pass = document.getElementById('login-pass').value;
  if (!phone || !pass) return document.getElementById('login-msg').innerText = 'phone + password required';
  document.getElementById('login-msg').innerText = 'Signing in...';
  try {
    const res = await fetch(API_BASE + '/api/contractor/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, password: pass })});
    const j = await res.json();
    if (!j.ok) return document.getElementById('login-msg').innerText = 'Login failed: ' + (j.error||'unknown');
    CURRENT_CONTRACTOR = j.contractor;
    showContractor();
  } catch (e) {
    document.getElementById('login-msg').innerText = String(e);
  }
});

document.getElementById('logout-btn')?.addEventListener('click', ()=>{
  CURRENT_CONTRACTOR = null;
  location.reload();
});

function showContractor(){
  document.getElementById('login-card').style.display='none';
  document.getElementById('profile-card').style.display='';
  document.getElementById('profile-name').innerText = CURRENT_CONTRACTOR.company || CURRENT_CONTRACTOR.name || 'Contractor';
  document.getElementById('profile-phone').innerText = CURRENT_CONTRACTOR.phone || '';
  document.getElementById('contractor-welcome').innerText = 'Welcome, ' + (CURRENT_CONTRACTOR.company || CURRENT_CONTRACTOR.name || '');
  document.getElementById('overview').style.display='';
  fetchContractorData();
  setInterval(fetchContractorData, 10000);
}

async function fetchContractorData(){
  // leads
  const res = await fetch(API_BASE + '/api/leads');
  const j = await res.json();
  const all = j.leads||[];
  const mine = all.filter(l => String(l.contractor_id) === String(CURRENT_CONTRACTOR.id));
  document.getElementById('ct-leads').innerText = mine.length;
  document.getElementById('ct-accepted').innerText = mine.filter(x=>x.status==='accepted').length || 0;
  document.getElementById('ct-response').innerText = 'N/A';
  const recent = document.getElementById('recent-leads');
  recent.innerHTML='';
  mine.slice(0,6).forEach(l=>{
    const d = document.createElement('div'); d.className='muted'; d.style.marginTop='8px';
    d.innerHTML = `<strong>${l.name}</strong><div class="muted">${l.phone} • ${l.service}</div>`;
    recent.appendChild(d);
  });
  // messages
  const mres = await fetch(API_BASE + '/api/messages');
  const mj = await mres.json();
  const messages = (mj.messages||[]).filter(m => !m.contractor_id || String(m.contractor_id) === String(CURRENT_CONTRACTOR.id));
  const container = document.getElementById('messages');
  container.innerHTML='';
  messages.slice(0,50).forEach(m=>{
    const el = document.createElement('div'); el.className='msg';
    el.innerHTML = `<div style="font-size:13px"><strong>${m.sender}</strong> <span class="muted">${new Date(m.created_at||'').toLocaleString()}</span></div><div style="margin-top:6px">${m.message}</div>`;
    container.appendChild(el);
  });
  // premium block
  if (document.getElementById('premium-toggle')?.value === '1') {
    document.getElementById('premium-content').innerHTML = `<div>Active premium analytics (demo). Leads by week: ${mine.length}</div>`;
  }
}

document.getElementById('send-out').addEventListener('click', async ()=>{
  const message = document.getElementById('out-msg').value.trim();
  if (!message) return alert('enter message');
  const res = await fetch(API_BASE + '/api/message', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contractorId: CURRENT_CONTRACTOR.id, sender: CURRENT_CONTRACTOR.company||CURRENT_CONTRACTOR.name||'Contractor', message })});
  const j = await res.json();
  if (j.ok) { document.getElementById('out-msg').value=''; fetchContractorData(); alert('Sent'); }
  else alert('Failed');
});

document.getElementById('refresh-btn').addEventListener('click', ()=> { if (CURRENT_CONTRACTOR) fetchContractorData(); });

// theme/premium toggles (local only)
document.getElementById('ui-theme').addEventListener('change', (e)=> {
  const v = e.target.value;
  document.documentElement.style.background = (v === 'light') ? '#f6f9fb' : '';
});
document.getElementById('premium-toggle').addEventListener('change', (e)=> {
  document.getElementById('premium-block').style.display = (e.target.value === '1') ? '' : 'none';
});

// If session exists in localStorage, auto-fill (simple)
const saved = localStorage.getItem('contractor_session');
if (saved) {
  try { const s = JSON.parse(saved); CURRENT_CONTRACTOR = s; showContractor(); }
  catch(e){}
}
</script>
</body>
</html>
