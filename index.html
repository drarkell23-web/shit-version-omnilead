<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>OmniSolutions — All-in-One Service Network</title>
<link rel="stylesheet" href="theme.css">
<script type="module" src="Firebase-bridge.js" defer></script>
<script type="module" src="confetti.js" defer></script>
</head>
<body>
  <div class="shell">
    <!-- LEFT SIDEBAR: generated (see inline script below) -->
    <aside id="leftSidebar" class="leftbar" aria-label="Service categories">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <button id="contractorDashBtnTop" class="btn">Contractor Dashboard</button>
        <button id="reviewsBtn" class="btn" style="margin-left:6px;">Reviews</button>
        <button id="adminBadgeBtn" class="btn" style="margin-left:auto;display:none;background:linear-gradient(90deg,#ff9a00,#ff4d6d);padding:6px 10px;border-radius:10px;font-weight:700;">Admin</button>
      </div>
      <h3 style="color:var(--muted);margin-top:0">Categories</h3>
      <div id="categoriesContainer" style="display:flex;flex-direction:column;gap:10px;max-height:78vh;overflow:auto;padding-right:6px;"></div>
      <div style="margin-top:14px;border-top:1px solid #ffffff08;padding-top:12px">
        <button id="topContractorsBtn" class="btn" style="width:100%;margin-bottom:8px;">Top Contractors (Platinum)</button>
        <div style="display:flex;gap:8px;">
          <button id="allServicesBtn" class="btn" style="flex:1;">All Services</button>
          <button id="contactUsBtn" class="btn" style="flex:1;">Contact</button>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="content">
      <header><h1>OmniSolutions</h1><p>Your all-in-one platform for services. Use chat to request help — we’ll match you.</p></header>

      <section class="card">
        <h2>Popular Services</h2>
        <div id="popularServices" style="display:flex;flex-wrap:wrap"></div>
      </section>

      <section class="card">
        <h2>Why Choose Us</h2>
        <ul>
          <li>Verified contractors</li>
          <li>Instant notifications via Telegram</li>
          <li>Premium tools for top contractors</li>
        </ul>
      </section>
    </main>
  </div>

  <!-- Chat widget -->
  <div id="chatWidget" style="position:fixed;right:18px;bottom:18px;z-index:2000">
    <button id="openChat" class="btn" style="border-radius:999px;padding:12px 14px">Chat</button>
    <div id="chatWindow" style="width:340px;max-width:92vw;display:none;flex-direction:column;position:fixed;right:18px;bottom:70px;z-index:2100">
      <div style="background:linear-gradient(90deg,var(--accent-from),var(--accent-to));padding:10px;border-radius:10px 10px 0 0;color:white;font-weight:700">Omni Chat</div>
      <div id="chatMsgs" style="background:linear-gradient(180deg,#070416,#0b0813);height:280px;overflow:auto;padding:12px;display:flex;flex-direction:column-reverse"></div>
      <div style="display:flex;gap:8px;padding:10px;background:#070417;border-radius:0 0 10px 10px">
        <input id="chatInput" class="small-input" placeholder="Type your message...">
        <button id="chatSend" class="btn">Send</button>
      </div>
    </div>
  </div>

  <canvas id="confettiCanvas" style="position:fixed;left:0;top:0;right:0;height:0;pointer-events:none;z-index:2200"></canvas>

<script type="module">
/* index frontend: categories, serviceList generation, chat flow, confetti init */
import confettiSpark from './confetti.js';
import { createLead } from './Firebase-bridge.js';

confettiSpark.init(document.getElementById('confettiCanvas'));

// generate a large service list (100+ services) by combining categories
const categories = [
  { id:"property", title:"Property & Maintenance" },
  { id:"cleaning", title:"Cleaning & Hygiene" },
  { id:"security", title:"Security & Energy" },
  { id:"garden", title:"Outdoor & Garden" },
  { id:"appliances", title:"Appliances & Repairs" },
  { id:"handyman", title:"Handyman & Small Jobs" },
  { id:"moving", title:"Moving & Storage" },
  { id:"renovation", title:"Renovation & Building" },
  { id:"electrical", title:"Electrical" },
  { id:"plumbing", title:"Plumbing" },
  { id:"decor", title:"Decor & Interiors" },
  { id:"it", title:"IT & Networking" },
  { id:"auto", title:"Automotive" },
  { id:"events", title:"Events & Rentals" },
  { id:"health", title:"Health & Wellness" },
  { id:"finance", title:"Financial" },
  { id:"legal", title:"Legal & Admin" },
  { id:"pet", title:"Pets" },
  { id:"fitness", title:"Fitness" },
  { id:"misc", title:"Miscellaneous" }
];

function buildLargeServiceList() {
  const list = [];
  let idx = 0;
  for (const c of categories) {
    const seeds = [
      "Inspection","Repair","Installation","Maintenance","Cleaning","Replacement","Upgrade","Emergency"
    ];
    for (let s=0;s<12;s++){
      const name = `${seeds[s % seeds.length]} ${c.title.split(' ')[0]} Service ${s+1}`;
      list.push({ id: `${c.id}-${idx++}`, cat: c.id, name });
    }
  }
  // make sure >100
  while (list.length < 220) {
    const c = categories[Math.floor(Math.random()*categories.length)];
    list.push({ id: `${c.id}-${idx++}`, cat: c.id, name: `General ${c.title} Service ${idx}` });
  }
  return list;
}
window.serviceList = buildLargeServiceList();

// render sidebar categories (reuse server-provided snippet concept)
const categoriesContainer = document.getElementById('categoriesContainer');
categories.forEach(cat => {
  const row = document.createElement('div'); row.className = 'category-row';
  const toggle = document.createElement('div'); toggle.className = 'cat-toggle';
  toggle.innerHTML = `<span>${cat.title}</span><span style="opacity:.6">▸</span>`;
  const sList = document.createElement('div'); sList.className = 'services-list';
  const svcs = window.serviceList.filter(s => s.cat === cat.id).slice(0,40);
  svcs.forEach(svc => {
    const b = document.createElement('button');
    b.className = 'svc-bubble';
    b.textContent = svc.name;
    b.addEventListener('click', ()=> openChatWithService(`${cat.title} › ${svc.name}`, svc.id));
    sList.appendChild(b);
  });
  toggle.addEventListener('click', ()=> {
    const open = sList.classList.toggle('open');
    toggle.querySelector('span:last-child').textContent = open ? '▾' : '▸';
  });
  row.appendChild(toggle);
  row.appendChild(sList);
  categoriesContainer.appendChild(row);
});

// popular services UI
const popular = document.getElementById('popularServices');
window.serviceList.slice(0,24).forEach(s=>{
  const el = document.createElement('button');
  el.className = 'svc-bubble';
  el.textContent = s.name;
  el.addEventListener('click', ()=> openChatWithService(s.name, s.id));
  popular.appendChild(el);
});

// Chat state (multi-step full conversation)
const chatWindow = document.getElementById('chatWindow');
const chatMsgs = document.getElementById('chatMsgs');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const openChatBtn = document.getElementById('openChat');

let convo = { step: 0, data: {} };

function pushBot(msg) {
  const el = document.createElement('div'); el.style.padding='8px'; el.style.borderRadius='8px'; el.style.background='#0f0b1a'; el.style.color='var(--muted)'; el.style.marginBottom='8px'; el.textContent = msg;
  chatMsgs.prepend(el);
}
function pushUser(msg) {
  const el = document.createElement('div'); el.style.padding='8px'; el.style.borderRadius='8px'; el.style.background='linear-gradient(90deg,var(--accent-from),var(--accent-to))'; el.style.color='#fff'; el.style.marginBottom='8px'; el.style.alignSelf='flex-end'; el.textContent = msg;
  chatMsgs.prepend(el);
}

openChatBtn.addEventListener('click', () => {
  chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
  if (chatWindow.style.display === 'flex') startConvo();
});

chatSend.addEventListener('click', () => handleInput());
chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleInput(); });

function startConvo() {
  convo = { step: 1, data: {} };
  chatMsgs.innerHTML = '';
  pushBot("Hi — I'm OmniChat. I'll help get your request. What's your full name?");
  chatInput.focus();
}

function openChatWithService(serviceName, serviceId) {
  // start with prefilled service
  convo = { step: 2, data: { service: serviceName, serviceId } };
  chatMsgs.innerHTML = '';
  pushBot(`You chose: ${serviceName}. What's your full name?`);
  chatInput.focus();
}

async function handleInput() {
  const text = chatInput.value.trim();
  if (!text) return;
  pushUser(text);
  chatInput.value = '';
  if (convo.step === 1) {
    convo.data.name = text;
    convo.step = 2;
    pushBot("Thanks — what's the best phone number to reach you?");
  } else if (convo.step === 2) {
    // if service prefilled, this step is phone; else this is service
    if (!convo.data.service) {
      convo.data.phone = text;
      convo.step = 3;
      pushBot("Which service do you need? (Pick from suggestions or type it)");
    } else {
      convo.data.phone = text;
      convo.step = 3;
      pushBot("Any extra details we should include? (address, time availability, etc.)");
    }
  } else if (convo.step === 3) {
    // message/details
    convo.data.message = text;
    convo.step = 4;
    pushBot("One last thing — do you have a preferred contractor? (name or leave blank)");
  } else if (convo.step === 4) {
    convo.data.preferred = text;
    // confirm & send
    pushBot("Thanks — sending your request now. You'll see a confirmation in a moment.");
    // trigger confetti
    confettiSpark.shoot(120);
    // prepare payload (minimal info to telegram)
    const payload = {
      name: convo.data.name || "Unknown",
      phone: convo.data.phone || "Unknown",
      email: "",
      service: convo.data.service || convo.data.preferred || "General",
      message: convo.data.message || "",
      // include preferred contractor id or name so server can route
      contractorId: convo.data.preferred ? convo.data.preferred : undefined
    };
    try {
      await createLead(payload); // optional Firestore + backend
    } catch (e) { console.warn(e); }
    try {
      const resp = await fetch('/api/lead', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      const j = await resp.json();
      if (j.ok) pushBot("✅ Request sent — contractors will contact you. Thank you!");
      else pushBot("❌ Failed to send. Please try again later.");
    } catch (err) {
      pushBot("❌ Server error. Try again later.");
    }
    // reset
    setTimeout(()=> { convo = { step:0, data:{} }; }, 1200);
  }
}

// admin badge visibility check
(async ()=> {
  try {
    const r = await fetch('/api/admin-secret'); const j = await r.json();
    if (j && j.secret) document.getElementById('adminBadgeBtn').style.display='inline-block';
  } catch(e){}
})();

// wire top buttons
document.getElementById('contractorDashBtnTop').addEventListener('click', ()=> window.location.href = '/contractor-dashboard.html');
document.getElementById('reviewsBtn').addEventListener('click', ()=> window.location.href = '/reviews.html');
document.getElementById('topContractorsBtn').addEventListener('click', ()=> { /* open modal implemented on server pages or client */ alert('Top contractors list opened'); });
document.getElementById('allServicesBtn').addEventListener('click', ()=> { document.querySelectorAll('.services-list').forEach(s=> s.classList.add('open')); });
document.getElementById('contactUsBtn').addEventListener('click', ()=> window.location.href='/contact.html');

</script>
</body>
</html>
